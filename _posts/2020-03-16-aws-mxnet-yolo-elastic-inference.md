---
layout: post
title: MXNet SSD λ””ν…ν„°λ¥Ό AWS Elastic Inference μ— μ¬λ¦¬κΈ°
excerpt: MXNet SSD Detector on AWS EI
author: vincent
email: ldg55d@gmail.com
tags: mxnet ssd eia aws ei elastic-inference
publish: true
---

## TL;DR

μ½”λ“λ” μ—¬κΈ°[^1]

EI λ” μ•„μ§ ν•κ³„μ μ΄ λ…ν™•ν μλ‹¤.(μ§€μ›μ•λλ” λ¨λΈλ“¤μ΄λΌλκ°€ κ³ μ •ν¬κΈ°μ μ΄λ―Έμ§€ λΌλκ°€)

μ΄λ° ν•κ³„μ λ“¤λ§ κ±Έλ¦¬μ§€ μ•κ³  EI λ¥Ό μ“Έ μ μλ‹¤λ©΄ λ¬΄μ΅°κ±΄ μ“°λ”κ² μ΄λ“μ΄λ‹¤.

## μ‹μ‘ν•λ©°

P3 λ¨λΈλ΅ μ„Έμ΄μ§€λ©”μ΄μ»¤ μ—”λ“ν¬μΈνΈλ¥Ό μ„λΉ„μ¤ν•λ”λ° λΉ„μ©μ΄ λ„λ¬΄ λ§μ΄ λ“λ” λ¬Έμ κ°€ μμ—λ‹¤.

μ΄λ°μ €λ° λ€μ•μ„ μ°Ύλ‹¤κ°€ Elastic Inference λ¥Ό μ‚¬μ©ν•΄λ³΄κΈ°λ΅ ν–λ”λ° κ²°κ³Όκ°€ λ„λ¬΄ λ§μ— λ“¤μ–΄μ„ κ³µμ μ°¨μ›μΌλ΅ μ¬λ¦°λ‹¤.

## Elastic Inference λ” μ–΄λ–»κ² λ™μ‘ν•λ”κ°€?

μ—¬κΈ°[^2]μ— EI κ°€ μ–΄λ–»κ² λ™μ‘ν•λ”μ§€ μ λ‚μ¤λ‹ μ°Έκ³ ν•μ.

μ‰½κ² λ§ν•λ©΄ EIA μ§€μ› μ—”λ“ν¬μΈνΈλ¥Ό μƒμ„±ν•λ©΄ EI λ¥Ό νΈμ¶ν•  μ μλ” VPC Endpoint λ¥Ό ν¬ν•¨ν• μ»¨ν…μ΄λ„μ— μ—”λ“ν¬μΈνΈκ°€ μƒμ„±λκ³  νΈμ¶μ‹ warm start κ³Όμ •μ„ κ±°μ³μ„ EI κΈ°λ¥μ„ μ‚¬μ©ν•  μ μλ‹¤.(ν”„λ΅λΉ„μ „λ λλ‹¤ λλ‚)

## μ½”λ“ μ„¤λ…

λ ν¬[^1]μ— μλ” λ…ΈνΈλ¶μ„ λ³΄λ©΄ λ‚΄μ©μ΄ μ‰½κ³  μ§§κΈ° λ•λ¬Έμ— μμ„Έν• μ„¤λ…μ€ ν•μ§€ μ•λ”λ‹¤. ν•µμ‹¬ μ‚¬ν•­λ“¤λ§ λ‡κ°€μ§€ μ§κ³  λ„μ–΄κ°€μ.

### Role

μ„Έμ΄μ§€λ©”μ΄μ»¤ λ…ΈνΈλ¶μ„ λ§λ“¤κ³  ν•΄λ‹Ή λ ν¬λ¥Ό clone ν•΄μ„ μ§„ν–‰ν•λ” κ²ƒμ΄ μ μΌ νΈν•μ§€λ§, λ΅μ»¬μ—μ„λ„ λλ¦¬κ³  μ‹¶μ€ κ²½μ°κ°€ μμ–΄μ„~~λ‚μ κ²½μ°~~ λ΅μ»¬μ—μ„λ„ λλ¦΄ μ μλ„λ΅ μ‘μ—…μ΄ λμ–΄ μλ‹¤.

λ‹¤λ§, ν•΄λ‹Ή λ…ΈνΈλ¶μ κΈ°λ¥μ„ μ‚¬μ©ν•κΈ° μ„ν•΄μ„ *AmazonSageMakerFullAccess* ν΄λ¦¬μ‹λ¥Ό κ°€μ§„ Roleμ΄ ν•„μ”ν•λ°, ν•΄λ‹Ή ν΄λ¦¬μ‹μ—λ” S3 μ—…λ΅λ“/λ‹¤μ΄λ΅λ“ λ¥Ό ν¬ν•¨ν• λ‹¤μ–‘ν• κ¶ν•λ“¤μ΄ ν¬ν•¨λμ–΄ μλ‹¤.

ν•΄λ‹Ή ν΄λ¦¬μ‹λ¥Ό λ¶€μ—¬ν• λ΅¤μ„ μƒμ„±ν•κ³ , λ΅¤ μ΄λ¦„μ„ λ…ΈνΈλ¶μ *role_name* μ— κ°’μ„ λ°”κΏ”μ„ μ μ–΄μ¤€λ‹¤.

λ, λ…ΈνΈλ¶μ€ μ•„λμ™€ κ°™μ΄ κΈ°λ³Έ λ²„ν‚·μ„ μ‚¬μ©ν•λ‹¤.

```python
BUCKET_NAME = sagemaker.Session().default_bucket()
session = boto3.session.Session()
s3 = session.resource('s3')
bucket = s3.Bucket(BUCKET_NAME)
```

μ²μμ—” ν•΄λ‹Ή λ²„ν‚·μ΄ μ—†κΈ° λ•λ¬Έμ— *BUCKET_NAME* μ„ ν™•μΈν•΄μ„ μ§μ ‘ μƒμ„±ν•΄μ£Όλ„λ΅ ν•μ. μ„μ—μ„ μ–ΈκΈ‰ν• λ΅¤μ ν΄λ¦¬μ‹μ— *sagemaker* λΌλ” λ‹¨μ–΄κ°€ ν¬ν•¨λ λ²„ν‚·μ— μ ‘κ·Όν•  κ¶ν•μ„ κ°€μ§€κ³  μκΈ° λ•λ¬Έμ— λ”°λ΅ κ¶ν•μ„ μƒμ„±ν•΄μ¤„ ν•„μ”λ” μ—†λ‹¤.

### model.tar.gz

mxnet inference μ»¨ν…μ΄λ„λ” μ²μ μΈμ¤ν„΄μ¤ μƒμ„±μ‹ *model.tar.gz* νμΌμ„ */opt/ml/models* μ•„λμ— λ‹¤μ΄λ°›κ³  μ••μ¶•μ„ ν’€μ–΄μ¤€λ‹¤. μ΄ μ•μ—λ” μΌλ°μ μΌλ΅ *model.params* κ³Ό κ°™μ΄ ν•™μµλ λ¨λΈ νλΌλ―Έν„°κ°€ ν¬ν•¨λλ‹¤. 

`src/inference.py` λ¥Ό λ³΄λ©΄ μ• μ μμ§€λ§, μ—¬κΈ°μ„λ” λ”°λ΅ ν•™μµλ λ¨λΈμ„ μ“°μ§€ μ•κ³  MXNet μ—μ„ μ κ³µν•λ” pretrained λ¨λΈμ„ μ‚¬μ©ν•λ‹¤. λ”°λΌμ„ λΉ model.tar.gz λ¥Ό λ―Έλ¦¬ μƒμ„±ν•΄λ‘κ³  κ·Έλƒ¥ μ—…λ΅λ“λ§ ν•λ‹¤.

```python
# upload emtpy model.tar.gz
bucket.upload_file('model.tar.gz', Key='ssd_test/model.tar.gz')
```

### inference.py

λ§μ§€λ§‰μΌλ΅ inference.py λ‚΄μ©λ§ κ°„λ‹¨ν μ‚΄ν΄λ³΄μ.

inference λ¨λ“μ€ 4κ°μ ν•¨μλ΅ λμ–΄ μλ‹¤. κ°κ° mode_fn, input_fn, predict_fn, output_fn μ΄λ‹¤.

* model_fn - λ¨λΈλ΅λ“. μµμ΄ μΈμ¤ν„΄μ¤κ°€ μƒμ„±λ λ• λ¨λΈμ„ λ΅λ“ν•κ³  λ΅λ“ν• λ¨λΈμ„ λ¦¬ν„΄ν•λ‹¤. μ΄ λ¨λΈμ€ μΊμ‹λμ–΄ μλ‹¤κ°€ μΈνΌλ°μ¤μ‹ predict_fn μΌλ΅ μ „λ‹¬λλ‹¤.
* input_fn - μ „μ²λ¦¬. μ—”λ“ν¬μΈνΈ μ”μ²­μ‹ *request_body* μ™€ *content_type* μ΄ μ…λ ¥λλ‹¤. μ…λ ¥λ°μ΄ν„°μ— λ€ν•΄ μ „μ²λ¦¬λ¥Ό ν•κ³  predict_fn μ— μ „λ‹¬λλ‹¤.
* predict_fn - μΈνΌλ°μ¤. model_fn μ—μ„ μ „λ‹¬λ°›μ€ λ¨λΈμ„ μ΄μ©ν•μ—¬ μΈνΌλ°μ¤λ¥Ό ν•κ³  κ²°κ³Όλ¥Ό λ°ν™ν•μ—¬ output_fn μΌλ΅ λ³΄λ‚Έλ‹¤.
* output_fn - ν›„μ²λ¦¬. μΈνΌλ°μ¤ κ²°κ³Όλ¥Ό λ°›μ•„μ„ κ°€κ³µν•  ν•„μ”κ°€ μμΌλ©΄ μ μ ν κ°€κ³µν•΄μ„ λ°ν™ν•λ‹¤.

ν•¨μ μ΄λ¦„μ΄λ‚ λ°μ΄ν„° νλ¦„μ€ μ§κ΄€μ μ΄κΈ° λ•λ¬Έμ— ν° μ–΄λ ¤μ›€μ€ μ—†μ„ κ²ƒμ΄λ‹¤.

λ³Έλ¬Έμ—μ„λ” μ΄λ―Έμ§€ λ°μ΄ν„°λ¥Ό λ‹¤λ£¨κΈ° λ•λ¬Έμ— bas64 λ¥Ό μ΄μ©ν•μ—¬ μ΄λ―Έμ§€λ¥Ό encode/decode ν•κ³  μμΌλ©°, ν•΄λ‹Ή λ‚΄μ©μ„ μ μ™Έν•λ©΄ νν† λ¦¬μ–Ό[^3] λ“±μ—μ„ λ¨λΈμ„ μ‚¬μ©ν•λ” κ²ƒκ³Ό μ™„μ „ν λ™μΌν•λ‹¤.

## λ§μΉλ©°

λ™μΌν• λ¨λΈμ„ cpu μ—μ„ 0.8μ΄ μ •λ„ κ±Έλ¦¬λ”λ° ei λ¥Ό μ‚¬μ©ν•λ©΄ λ€λµ 0.08μ΄μ•μ— μ²λ¦¬κ°€ λλ‹¤.(10λ°°)

----
[^1]: [mxnet-elastic-inference](https://github.com/haandol/mxnet-elastic-inference)
[^2]: [Amazon Elastic Inference Basics](https://docs.aws.amazon.com/elastic-inference/latest/developerguide/basics.html)
[^3]: [Predict with pre-trained SSD models](https://gluon-cv.mxnet.io/build/examples_detection/demo_ssd.html)